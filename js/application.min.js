$(document).ready(function(){var a=$(window).height(),b=$(window).width();$("#wv-loop").css("height",a+"px"),$("#donut-1-container").css("height",b/3+"px"),app=new App,$(window).load(function(){$("body").removeClass("no-scroll"),$(".spinner").hide(),$("#loading").html("scroll down"),app.initMap(),app.donutChart()})}),App=function(){var a=this;this._wire(),this.effects(),$("#main-title").fadeIn(),$("#video-boulder-container, #video-precip-animation-container, #video-fullscreen-container, #video-fullscreen-post-deluge-container").appear(),$("#video-precip-animation-container").on("appear",function(){$(this).hasClass("is-active")||(a.playVideo("video-precip-animation"),$(this).addClass("is-active"))}),$("#video-precip-animation-container").on("disappear",function(){a.stopVideo("video-precip-animation"),$(this).removeClass("is-active")}),$("#video-fullscreen-container").on("appear",function(){$(this).hasClass("is-active")||(a.playVideo("video-fullscreen"),$(this).addClass("is-active"))}),$("#video-fullscreen-container").on("disappear",function(){a.stopVideo("video-fullscreen"),$(this).removeClass("is-active")}),$("#video-fullscreen-post-deluge-container").on("appear",function(){$(this).hasClass("is-active")||(a.playVideo("video-fullscreen-post-deluge"),$(this).addClass("is-active"))}),$("#video-fullscreen-post-deluge-container").on("disappear",function(){a.stopVideo("video-fullscreen-post-deluge"),$(this).removeClass("is-active")}),$("#play-boulder").on("click",function(){$(this).hasClass("playing")?($(this).removeClass("playing").html("PLAY"),a.stopVideo("video-boulder")):(a.playVideo("video-boulder"),$(this).addClass("playing").html("PAUSE"))})},App.prototype._wire=function(){var a=this,b=$(window).height();$(window).on("resize",function(){b=$(window).height(),width=$(window).width(),$("#section-one").css("height",b+"px"),$("#map").css("width",width+"px"),$("#map").css("height",b+"px")}),$("img.lazy").lazyload(),$(window).scroll(function(){$("body").hasClass("no-scroll")||($("#loading").fadeOut(),a.updateOuterRadial(),a.watchFixedElements())})},App.prototype.playVideo=function(a){var b=document.getElementById(a);b.play(),b.volume=.2},App.prototype.stopVideo=function(a){if(a){var b=document.getElementById(a);b&&b.pause()}},App.prototype.watchFixedElements=function(){var a=$(window).scrollTop();a>2700?$("#map").hide():$("#map").show(),8107>a?$("#wv-loop").hide():$("#wv-loop").show()},App.prototype.donutChart=function(){var a=this;$("#donut-1 svg").remove(),this.chartWidth=$(window).width()/3,this.chartHeight=$(window).width()/3,this.chartRadius=Math.min(this.chartWidth,this.chartHeight)/2;var b=d3.scale.ordinal().range(["#ecf0f1","#d0dde8","#98b6d5","#2980b9","#2980b9","#2980b9","#5f96c4","#5f96c4","#98b6d5","#98b6d5","#a9c1db","#cbd9e6","#ecf0f1"]),c=d3.svg.arc().outerRadius(this.chartRadius-15).innerRadius(this.chartRadius-115),d=d3.layout.pie().sort(null).value(function(a){return a.total}),e=d3.select("#donut-1").append("svg").attr("width",this.chartWidth).attr("height",this.chartHeight).append("g").attr("transform","translate("+this.chartWidth/2+","+this.chartHeight/2+")");d3.csv("data/boulder-precip.csv",function(f,g){g.forEach(function(a){a.total=+a.total}),a.chartGraphic=e.selectAll(".arc").data(d(g)).enter().append("g").attr("class","arc"),a.chartGraphic.append("path").attr("d",c).style("fill",function(a){return b(a.data.month)}).on("mouseover",function(b){clearTimeout(a.hideTooltip),$("#donut-tooltip").fadeIn().css({left:d3.event.offsetX+100+"px",top:d3.event.offsetY+"px"}),$("#donut-tooltip").html("Boulder averages "+b.data.total+" inches of precipitation in "+b.data.month),a.hideTooltip=setTimeout(function(){$("#donut-tooltip").fadeOut()},1700)}),a.chartGraphic.append("text").attr("transform",function(a){return"translate("+c.centroid(a)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(a){return a.data.month}),a.chartGraphic.append("text").attr("transform",function(){return"translate(0,0)"}).attr("dy",".35em").style("fill","#000").style("text-anchor","middle").text(function(){return'20.23" Annually'}),a.outerRadial()})},App.prototype.outerRadial=function(){var a=this,b=Math.PI;this.arc2=d3.svg.arc().outerRadius(this.chartRadius-2).innerRadius(this.chartRadius-12).startAngle(0*(b/180)),this.arcPath=this.chartGraphic.append("path").datum({endAngle:0}).style("fill","#1abc9c").attr("d",a.arc2)},App.prototype.updateOuterRadial=function(){function a(a,c){a.attrTween("d",function(a){var d=d3.interpolate(a.endAngle,c);return function(c){return a.endAngle=d(c),b.arc2(a)}})}var b=this,c=Math.PI,d=$(window).scrollTop()+200,e=$("#donut-1").offset().top,f=.85*2*c,g=f-(d-e)*(f/(200-e));g>f||this.arcPath&&this.arcPath.transition().duration(50).call(a,g)},App.prototype.effects=function(){var a=$.scrollorama({blocks:".scrollblock",enablePin:!1}),b=$(window).height();$(window).width(),a.animate("#section-one h1",{delay:100,duration:500,property:"margin-top",start:b/2-100,end:b/2+100}),a.animate("#section-one h2",{delay:100,duration:500,property:"margin-top",start:b/2,end:b/2+200}),a.animate("#video-fullscreen-container",{delay:b/1.5,duration:250,property:"opacity",start:0,end:1}),a.animate("#video-fullscreen-post-deluge-container",{delay:b-280,duration:250,property:"opacity",start:0,end:1}),a.animate("#lyons-img",{delay:600,duration:400,property:"height",start:0,end:405}),a.animate("#estes-76-two",{delay:b+200,duration:100,property:"opacity",start:1,end:0}),a.animate("#footer",{delay:0,duration:400,property:"height",start:0,end:300})},App.prototype.initMap=function(){function a(a){if(f||a){null!==g&&(p.scale(g),g=null),null!==h&&(p.translate(h),h=null);var b=l.scale(p.scale()).translate(p.translate())();m.scale(p.scale()/2/Math.PI).translate(p.translate());var d=r.style(k+"transform",c(b.scale,b.translate)).selectAll(".tile").data(b,function(a){return a});d.exit().each(function(){this._xhr.abort()}).remove(),d.enter().append("svg").attr("class","tile").style("left",function(a){return 256*a[0]+"px"}).style("top",function(a){return 256*a[1]+"px"}).each(function(a){var b=d3.select(this);this._xhr=d3.json("http://"+["a","b","c"][(31*a[0]+a[1])%3]+".tile.openstreetmap.us/vectiles-highroad/"+a[2]+"/"+a[0]+"/"+a[1]+".json",function(c,d){var e=256*Math.pow(2,a[2]);o.projection().translate([e/2-256*a[0],e/2-256*a[1]]).scale(e/2/Math.PI),b.selectAll("path").data(d.features.sort(function(a,b){return a.properties.sort_key-b.properties.sort_key})).enter().append("path").attr("class",function(a){return a.properties.kind}).attr("d",o)})}),d3.selectAll("circle").attr("cx",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[0]}).attr("cy",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[1]}),d3.selectAll(".places-label").attr("dx",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[0]}).attr("dy",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[1]-12})}else null===g&&(g=p.scale()),null===h&&(h=p.translate())}function b(){s.text(e(m.invert(d3.mouse(this)),p.scale()))}function c(a,b){var c=a/256,d=a%1?Number:Math.round;return"matrix3d("+[c,0,0,0,0,c,0,0,0,0,c,0,d(b[0]*a),d(b[1]*a),0,1]+")"}function d(a){for(var b=-1,c=a.length,d=document.body.style;++b<c;)if(a[b]+"Transform"in d)return"-"+a[b].toLowerCase()+"-";return""}function e(a,b){var c=d3.format("."+Math.floor(Math.log(b)/2-2)+"f");return(a[1]<0?c(-a[1])+"째S":c(a[1])+"째N")+" "+(a[0]<0?c(-a[0])+"째W":c(a[0])+"째E")}var f=!1,g=null,h=null;$(".scrollblock").on("hover",function(){$("#map-drag").removeClass("selected"),$("#map-tip").hide(),$("#intro-inset-map, #map-view-outer").css("pointer-events","auto"),f=!1}),$("#map-view-outer").on("click",function(){f?($("#map-drag").removeClass("selected"),$("#map-tip").hide(),$("#intro-inset-map, #map-view-outer").css("pointer-events","auto"),f=!1):($("#map-drag").addClass("selected"),$("#map-tip").show(),$("#intro-inset-map, #map-view-outer").css("pointer-events","none"),f=!0)});var i=Math.max(960,window.innerWidth),j=$(window).height(),k=d(["webkit","ms","Moz","O"]),l=d3.geo.tile().size([i,j]),m=d3.geo.mercator().scale(131072/Math.PI).translate([-i/2,-j/2]),n=d3.geo.mercator(),o=d3.geo.path().projection(n),p=d3.behavior.zoom().scale(2*m.scale()*Math.PI).scaleExtent([1<<18,1<<23]).translate(m([-105.1,40.1]).map(function(a){return-a})).on("zoom",a),q=d3.select("#map").style("width",i+"px").style("height",j+"px").call(p).on("mousemove",b),r=q.append("div").attr("class","layer"),s=q.append("div").attr("class","info");a(!0);var t=d3.select("#map").append("svg").attr("id","places").attr("width",i).attr("height",j);d3.geo.path().projection(m);var u=t.append("g");d3.json("data/places.json",function(a,b){u.selectAll("circle").data(b.features).enter().append("circle").attr("class","places").attr("cx",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[0]}).attr("cy",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[1]}).attr("r",10).on("click",function(a){var b=a.properties.Place.toLowerCase().replace(/ /g,"-");$(window).height(),$(window).scrollTop();var c={boulder:$("#section-three").offset().top,lyons:$("#section-four").offset().top,"estes-park":$("#section-four").offset().top,"eastern-plains":$("#section-six").offset().top};$("body,html").animate({scrollTop:c[b]},2400)}),u.selectAll("text").data(b.features).enter().append("text").attr("class","places-label").attr("dx",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[0]}).attr("dy",function(a){return m([a.geometry.coordinates[0],a.geometry.coordinates[1]])[1]-12}).text(function(a){return a.properties.Place})})};